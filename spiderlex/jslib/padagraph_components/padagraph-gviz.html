<link rel="import" href="../../static/bower_components/polymer/polymer.html"/><link rel="import" href="./padagraph-vertex-card-m.html"/><link rel="import" href="./padagraph-vertex-card-xs.html"/><link rel="import" href="./padagraph-edge-card-xl.html"/><link rel="import" href="./padagraph-card-property.html"/><!--dom-module(id='padagraph-gviz-label')--><dom-module id="padagraph-model-popup"><style>.card { width:400px}
.card .intersected { margin:4px; padding: 2px; border:none; }
a.more { padding-right:12px; margin-top: -12px; }

span.name {
       display: inline-block;
       color: #333;
       font-weight: bold;
       font-size: 1em;
       margin-right: 6px;
   }
//.position {
   //position:absolute;
   //top: 12px;
   //left: 12px;
   //max-height: calc(100% - 24px);
   //overflow-y: auto;
   //z-index:1;
//}
</style><template><template is="dom-if" if="{{ model }}"> <div class="ui card"><template is="dom-if" if="{{ is_edge }}"><div class="item"><padagraph-edge-card-xl model="{{model}}"></padagraph-edge-card-xl></div></template><template is="dom-if" if="{{ is_vertex }}"> <div class="intersected"><padagraph-vertex-card-m model="{{model}}"></padagraph-vertex-card-m><div style="overflow-y:auto;" class="content"><template is="dom-if" if="{{image}}"> <img src="{{image}}" class="ui small centered image"/><div class="ui divider"></div></template><template is="dom-repeat" items="[[props]]"> <div class="comment"><div class="content"><span class="name">{{item.name}}</span><padagraph-card-property prop="{{item}}" class="value"></padagraph-card-property></div></div></template></div></div></template></div></template></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-model-popup",

    properties: {
      graph: { type: Object, value: function value() {}, observer: 'graph_changed' },
      model: { type: Object, observer: "modelChanged" },
      is_vertex: { type: Boolean, computed: 'isVertex(model)' },
      is_edge: { type: Boolean, computed: 'isEdge(model)' }
    },

    created: function created() {
      this._listener = {};
      _.extend(this._listener, Backbone.Events);
    },

    graph_changed: function graph_changed(graph) {
      var _this = this;

      this._listener.stopListening();
      if (!graph || !_.size(graph)) return;

      this._listener.listenTo(this.graph.vs, 'addflag:selected', (function (model) {
        _this.model = model;
      }).bind(this));
      this._listener.listenTo(this.graph.vs, 'rmflag:selected', (function (model) {
        _this.model = null;
      }).bind(this));
      this._listener.listenTo(this.graph.es, 'addflag:selected', (function (model) {
        _this.model = model;
      }).bind(this));
      this._listener.listenTo(this.graph.es, 'rmflag:selected', (function (model) {
        _this.model = null;
      }).bind(this));
    },

    isEdge: function isEdge(model) {
      return model && model.get('edgetype') != null;
    },
    isVertex: function isVertex(model) {
      return model && model.get('nodetype') != null;
    },
    isGraph: function isGraph(model) {
      return model && model.nodetypes && model.edgetypes;
    },

    modelChanged: function modelChanged(model) {

      if (!model) return;

      this.image = model.properties.get('image');
      var exclude = { 'label': true, 'image': true };
      var _type = function _type(key) {
        if (model.type && model.type.properties) {
          var t = model.type.properties.get(key);
          if (t && t.otype) return t.otype.type.toLowerCase();
        }
        return "text";
      };
      this.props = Object.keys(model.properties.attributes).filter(function (e) {
        return !exclude[e];
      }).map(function (e) {
        return {
          "type": _type(e),
          "name": e,
          "value": model.properties.get(e)
        };
      });
    },

    rmflag: function rmflag(model) {
      this.model = null;
    }

  });
});</script></dom-module><dom-module id="padagraph-mouse-popup"><style>#pdg-mouse-popup {
   max-width: 600px;
   position: fixed;
   padding: 0 2 4 4px;
   margin-left: 2px;
   max-height: calc(100% - 24px);
}
.meta {
   margin: 2 2 8 8px;
 }
.intersected.ui.popup {
   max-width: 520px;
   position: relative;
   padding: 0.42em;
}
.intersected h4 {
   margin: 2 2 8 8px;
}
   </style><template><div id="pdg-mouse-popup" hidden$="{{!is_visible}}"><div class="intersected ui popup visible"><template is="dom-if" if="{{ edge }}"> <h4><i class="ellipsis horizontal icon"> </i>{{edge.type.label}}</h4><padagraph-vertex-card-xs id="source" model="[[edge_source]]"></padagraph-vertex-card-xs><a on-click="select" class="edge"><i class="ellipsis horizontal icon"></i></a><padagraph-vertex-card-xs id="target" model="[[edge_target]]"> </padagraph-vertex-card-xs><div class="meta"> {{edge.label}}</div></template><template is="dom-if" if="{{ vertex }}"> <h4><i class="square outline icon"></i>{{vertex.nodetype.name}}</h4><padagraph-vertex-card-xs model="[[vertex]]"></padagraph-vertex-card-xs></template></div></div></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-mouse-popup",

    properties: {
      graph: { type: Object, observer: 'graph_changed' },
      edge: { type: Object, value: null, observer: 'computed(edge)' },
      edge_source: {
        type: Object,
        computed: 'get_source_model(edge)'
      },
      edge_target: {
        type: Object,
        computed: 'get_target_model(edge)'
      },
      vertex: { type: Object, value: null },
      is_visible: {
        type: Boolean,
        computed: 'shouldShow(vertex, edge)'
      }
    },

    created: function created() {
      this._listener = {};
      _.extend(this._listener, Backbone.Events);
    },

    graph_changed: function graph_changed() {
      this._listener.stopListening();

      this._listener.listenTo(Backbone, 'edge:mouseover', (function (edge, event) {
        if (edge && edge.id) {
          this.edge = edge;
          this.vertex = null;
          this.setPopupPosition(event);
        }
      }).bind(this));

      this._listener.listenTo(Backbone, 'edge:mouseout', (function (edge, event) {
        this.edge = null;
        this.vertex = null;
      }).bind(this));

      this._listener.listenTo(Backbone, 'vertex:mouseover', (function (vertex, event) {
        if (vertex && vertex.id) {
          if (this.edge == null) {
            if (this.vertex != vertex) this.setPopupPosition(event);
            this.vertex = vertex;
          }
        }
      }).bind(this));

      this._listener.listenTo(Backbone, 'vertex:mouseout', (function (vertex, event) {
        this.edge = null;
        this.vertex = null;
      }).bind(this));
    },

    shouldShow: function shouldShow(vertex, edge) {
      return this.edge != null || this.vertex != null;
    },

    select: function select() {
      Backbone.trigger(Const.select_edge, this.edge);
    },

    get_source_model: function get_source_model(model) {
      if (model) return model.source;
    },
    get_target_model: function get_target_model(model) {
      if (model) return model.target;
    },

    setPopupPosition: function setPopupPosition(event) {
      var nav = navigator.userAgent.toLowerCase();
      var $el = $('#pdg-mouse-popup');
      var $parent = $el.parent();

      var browser = {
        webkit: nav.indexOf("webkit") > 0,
        mozilla: nav.indexOf("firefox") > 0
      };

      var height = $el.height();
      var top = $(this).parent().position().top,
          left = 0;

      if (browser.webkit) {
        //top  = event.pageY - top,
        //left = event.pageX - left;
        top = event.y;
        left = event.x;
      } else {
        top = event.pageY - top - $('body').scrollTop();
        //left = event.pageX  - left - $('body').scrollLeft();
        left = event.clientX;
      }

      $el.css({ 'top': top - 12,
        'left': left });
    },

    computed: function computed(obj) {

      if (!obj) return;

      var exclude = { 'label': true, 'image': true };

      var _type = function _type(key) {
        if (model.type && model.type.properties) {
          var t = model.type.properties.get(key);
          if (t && t.otype) return t.otype.type.toLowerCase();
        }
        return "text";
      };
      this.props = Object.keys(obj.properties.attributes).filter(function (e) {
        return !exclude[e];
      }).map(function (e) {
        return {
          "type": _type(e),
          "name": e,
          "value": obj.properties.get(e)
        };
      });
    }

  });
});</script></dom-module><dom-module id="padagraph-gviz-json"><template><content></content></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst', 'embed'], function (Backbone, Cello, Gviz, Materials, Const, App) {
  Polymer({
    is: "padagraph-gviz-json",

    properties: {

      config: { type: Object, value: function value() {
          return null;
        } },

      routes: Object,
      data: { type: Object, value: null },
      sync: { type: String, value: null }, // url

      on_complete: Object,

      /* privates */
      completed: Boolean,
      graph: Object
    },

    observers: ["configure(config)", "parse(routes, data, sync)", "onComplete(on_complete)"],
    //observers:["parse(pdgroot)"],

    onComplete: function onComplete(complete) {
      if (this.completed && complete) complete();
    },

    configure: function configure(config) {
      if (_.isString(config)) {
        // external configuration
        $.ajax({
          url: config,
          success: this.configure
        });
        return;
      }
      if (_.isObject(config)) {
        this.routes = config.routes;
        this.data = config.data;
        this.sync = config.sync;
      }
    },

    refresh: function refresh() {
      this.parse(this.routes, this.data, this.sync);
    },

    parse: function parse(routes, data, sync) {

      var parse = this;
      this.completed = false;

      var isurl = function isurl(e) {
        return _.isString(e);
      };

      if (isurl(routes)) {
        $.ajax({
          url: routes,
          success: function success(routes) {
            parse.set('routes', routes.routes);
          }
        });
        return;
      }

      if (isurl(data)) {
        $.ajax({
          url: data,
          success: function success(r) {
            parse.set('data', r);
          }
        });
        return;
      }

      if (!routes || !data) return;

      // app, models & engines
      var app;
      var app_params = {
        $el: $(this),
        'routes': routes
      };

      app = new App.Iframe(app_params);
      app.create_clustering_model();

      if (sync) {
        var gid = sync.substring(sync.lastIndexOf('/') + 1);
        var urlRoot = sync.substring(0, sync.lastIndexOf('/') + 1);
        app.create_graph_model({ urlRoot: urlRoot, url: sync });
        app.models.graph.set('gid', gid);
        app.create_query_model();
        app.models.query.graph = app.models.graph.id;
      } else {
        app.create_graph_model({});
        app.models.graph.attributes['gid'] = "g" + this.id;
      }

      var complete = function complete(app) {

        var graph = app.models.graph;
        var viz = $("padagraph-gviz", parse)[0];
        viz.graph = graph;
        viz.app = app;
        viz.options = Gviz.DEFAULTS;

        app.gviz = viz.gviz;
        app.set_auto_compute(false);

        var reset = function reset() {
          graph.reset(data, { silent: true });

          graph.vs.each(function (vtx) {
            vtx.add_flag("form");
          });

          app.set_auto_compute(true);
          app.auto_compute();
        };

        if (sync) {
          graph.on('sync', reset);
          graph.fetch({ parse: false });
        } else reset();

        parse.completed = true;
        parse.onComplete();
      };

      app.create_engines();
      app.fetch_engines(complete);

      this.graph = app.models.graph;
      this.app = app;

      var _window_resized = function _window_resized() {
        if (app.gviz) app.gviz.resize_rendering();
      };
      $(window).on('resize', _window_resized);

      // setuo callback
    }
  });
});</script></dom-module><dom-module id="padagraph-gviz"><template><div id="gviz_model_imgs" style="display:none"></div><canvas id="gviz_imgs_cache_canvas" style="display:none"></canvas><content> </content></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
    Polymer({
        is: "padagraph-gviz",

        properties: {

            app: { type: Object, value: function value() {} },
            graph: { type: Object, value: function value() {} },
            options: { type: Object, value: function value() {} }

        },

        observers: ["create_once(app, graph, options)"],

        init: function init(app, graph, options) {
            this.create_once(app, graph, options);
        },

        create_once: function create_once(app, graph, vizoptions) {

            if (app === undefined || graph === undefined) return;
            if (!app || graph == null || !graph.vs) return;
            if (this.gviz) return;

            var engines = _.zip([app.layouts, app.clusterings], $("padagraph-engine-control", this));

            _.each(engines, function (e, i, l) {
                var blocks = e[0];
                var el = e[1]; // polymer el
                if (el) {
                    el.app = app;
                    el.blocks = blocks;
                }
            });

            var filters = $("padagraph-collection-filter", this);
            if (filters.length) {
                _(filters).forEach(function (f) {
                    f.app = app;
                    f.graph = graph;
                });
            }

            var popup = $("padagraph-model-popup", this);
            if (popup.length) {
                popup = popup[0];
                popup.graph = graph;
            }

            var ctrl = $("padagraph-labels-control", this);
            if (ctrl.length) {
                ctrl = ctrl[0];
                ctrl.app = app;
                ctrl.graph = graph;
            }

            var options = _.extend({}, Gviz.DEFAULTS, vizoptions);
            if (!options['el']) options['el'] = "#vz_threejs_main" + Math.round(Math.random() * 10000);

            options.materials = Materials;

            var has_el = $(options.el, this).length > 0;
            var div = has_el ? $(options.el, this)[0] : document.createElement('div');
            div.setAttribute('id', options.el.substring(1));
            div.setAttribute('style', "height:100%");
            if (!has_el) this.appendChild(div);

            if (this.debug) {
                this.appendChild("<div class='gviz-debug'></div>");
            }

            this.options.wnode_scale = function (vtx) {
                var v = vtx.get('_size') * 8;
                return gviz.initial_size + gviz.user_vtx_size + v;
            };

            var gviz = Gviz.SimpleViz(graph, options);
            gviz.enable();
            gviz.animate();

            app.set_viz(gviz);

            this.gviz = gviz;
        }

    });
});</script></dom-module>